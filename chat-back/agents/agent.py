from pydantic import BaseModel
from typing import Optional, List
from openai import OpenAI
import json
import inspect
from dotenv import load_dotenv
from .tools import create_order


load_dotenv()

# –ü–æ–ª—É—á–∞–µ–º –∫–ª—é—á –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
OPENAI_API_KEY = "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"
client = OpenAI(api_key=OPENAI_API_KEY)

class Agent(BaseModel):
    name: str = "Agent"
    model: str = "gpt-4o-mini"
    instructions: str = "–¢—ã - –ø–æ–ª–µ–∑–Ω—ã–π –∞–≥–µ–Ω—Ç"
    tools: List[callable] = []

    class Config:
        arbitrary_types_allowed = True

class Response(BaseModel):
    agent: Optional[Agent]
    messages: list


def function_to_schema(func) -> dict:
    type_map = {
        str: "string",
        int: "integer",
        float: "number",
        bool: "boolean",
        list: "array",
        dict: "object",
        type(None): "null",
    }

    try:
        signature = inspect.signature(func)
    except ValueError as e:
        raise ValueError(
            f"Failed to get signature for function {func.__name__}: {str(e)}"
        )

    parameters = {}
    for param in signature.parameters.values():
        try:
            param_type = type_map.get(param.annotation, "string")
        except KeyError as e:
            raise KeyError(
                f"Unknown type annotation {param.annotation} for parameter {param.name}: {str(e)}"
            )
        parameters[param.name] = {"type": param_type}

    required = [
        param.name
        for param in signature.parameters.values()
        if param.default == inspect._empty
    ]

    return {
        "type": "function",
        "function": {
            "name": func.__name__,
            "description": (func.__doc__ or "").strip(),
            "parameters": {
                "type": "object",
                "properties": parameters,
                "required": required,
            },
        },
    }


def run_full_turn(agent, messages, retriever=None):
    """
    –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –æ–±—â–µ–Ω–∏—è –∞–≥–µ–Ω—Ç–∞

    :param agent: –¢–µ–∫—É—â–∏–π –∞–≥–µ–Ω—Ç
    :param messages: –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
    :param retriever: –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–µ—Ç—Ä–∏–≤–µ—Ä –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    """
    current_agent = agent

    print("üî•‚ú®üí•–í—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è:", messages)

    # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ—Ç —Ä–µ—Ç—Ä–∏–≤–µ—Ä–∞, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
    context_messages = []
    if retriever:
        # context_docs = retriever.invoke(messages[-1]['content'] if messages else "")
        # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–≤–∞ —Å–æ–æ–±—â–µ–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
        last_two_messages = messages[-2:] if len(messages) >= 2 else messages[-1:]
        combined_content = " ".join(msg['content'] for msg in last_two_messages)
        context_docs = retriever.invoke(combined_content if messages else "")

        print("üí•–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç:", context_docs)
        context_messages.append({
            "role": "system",
            "content": f"–ö–æ–Ω—Ç–µ–∫—Å—Ç: {context_docs}"
        })

    # –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ python –≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
    tool_schemas = [function_to_schema(tool) for tool in current_agent.tools]
    tools = {tool.__name__: tool for tool in current_agent.tools}

    # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏
    response = client.chat.completions.create(
        model=current_agent.model,
        messages=[
            {"role": "system", "content": current_agent.instructions},
            *context_messages,
            *messages
        ],
        tools=tool_schemas or None,
        temperature=0
    )

    message = response.choices[0].message
    messages.append(message.model_dump())

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–∑–æ–≤–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
    if message.tool_calls:
        for tool_call in message.tool_calls:
            name = tool_call.function.name
            tool_call_id = tool_call.id
            args = json.loads(tool_call.function.arguments)

            # –í—ã–∑–æ–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–∏ —Å –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏
            result = tools[name](**args)

            # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–µ
            messages.append({
                "role": "tool",
                "tool_call_id": tool_call_id,
                "content": str(result)
            })

            # –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç - –Ω–æ–≤—ã–π –∞–≥–µ–Ω—Ç, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è
            if isinstance(result, Agent):
                current_agent = result

                # –ü–æ–ª—É—á–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
        final_response = client.chat.completions.create(
            model=current_agent.model,
            messages=[
                {"role": "system", "content": current_agent.instructions},
                *context_messages,
                *messages
            ],
            temperature=0
        )

        final_message = final_response.choices[0].message
        messages.append(final_message.model_dump())

    return Response(
        agent=current_agent,
        messages=messages
    )


def transfer_to_sales_agent():
    """–ü–µ—Ä–µ–≤–æ–¥–∏—Ç —á–∞—Ç –≤ —Ä–µ–∂–∏–º –ø—Ä–æ–¥–∞–∂."""
    return sales_agent


def transfer_back_to_triage():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —á–∞—Ç –≤ —Ä–µ–∂–∏–º –ø–µ—Ä–≤–∏—á–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏."""
    return triage_agent


# # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤
triage_agent = Agent(
    name="–ê–≥–µ–Ω—Ç –ø–µ—Ä–≤–∏—á–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏",
    instructions=(
        """–í—ã - —ç–∫—Å–ø–µ—Ä—Ç-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º –≤ –∫–æ–º–ø–∞–Ω–∏–∏ '–ù–∞ —Å–≤—è–∑–∏', –∫–æ—Ç–æ—Ä—ã–π —Å–æ—á–µ—Ç–∞–µ—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–∏–∑–º —Å –∏—Å–∫—Ä–µ–Ω–Ω–∏–º —ç–Ω—Ç—É–∑–∏–∞–∑–º–æ–º –≤ –ø–æ–º–æ—â–∏ –∫–ª–∏–µ–Ω—Ç–∞–º.
           –í–∞—à–∞ —Ü–µ–ª—å - –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –¥–æ–≤–µ—Ä–∏–µ –∏ –ø—Ä–∏–Ω–µ—Å—Ç–∏ –ø–æ–ª—å–∑—É, –ø–æ–º–æ–≥–∞—è –∫–ª–∏–µ–Ω—Ç–∞–º –ø—Ä–∏–Ω—è—Ç—å –Ω–∞–∏–ª—É—á—à–µ–µ —Ä–µ—à–µ–Ω–∏–µ –æ –ø–æ–∫—É–ø–∫–µ –ø—Ä–æ–¥—É–∫—Ç–∞.

–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:
1. –ë—É–¥—å—Ç–µ –ø—Ä–∏–≤–µ—Ç–ª–∏–≤—ã –∏ –ª–∏—á–Ω–æ –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω–Ω—ã–º–∏ –≤ –ø–æ–º–æ—â–∏ –∫–ª–∏–µ–Ω—Ç—É.
2. –í—Å–µ–≥–¥–∞ –±—É–¥—å—Ç–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã –∏ —Å–∫—É—Ä–ø—É–ª–µ–∑–Ω—ã –∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É {context}.
3. –í—ã –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–µ—Ç–µ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç–µ —Ç–æ–≤–∞—Ä—ã —Ç–æ–ª—å–∫–æ –∏–∑ {context}.
4. –í—ã –≥–æ–≤–æ—Ä–∏—Ç–µ —Ç–æ–ª—å–∫–æ –æ —Ç–æ–≤–∞—Ä–∞—Ö.


–ü–†–ò–ú–ï–†–´ –ù–ï–ú–ï–î–õ–ï–ù–ù–û–ì–û –ü–†–ï–ö–†–ê–©–ï–ù–ò–Ø –î–ò–ê–õ–û–ì–ê:
   - –ó–∞–ø—Ä–æ—Å "–†–∞—Å—Å–∫–∞–∂–∏ –∞–Ω–µ–∫–¥–æ—Ç"
   - –ü—Ä–æ—Å—å–±–∞ –Ω–∞–ø–∏—Å–∞—Ç—å —Å—Ç–∏—Ö–æ—Ç–≤–æ—Ä–µ–Ω–∏–µ
   - –í–æ–ø—Ä–æ—Å—ã –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Ç–æ–≤–∞—Ä–∞–º–∏/–∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
   - –ü–æ–ø—ã—Ç–∫–∏ gameplay –∏–ª–∏ roleplay
   - –ó–∞–ø—Ä–æ—Å—ã –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤


!!!–ê–ë–°–û–õ–Æ–¢–ù–´–ô –ö–û–ù–¢–†–û–õ–¨ –¢–û–í–ê–†–û–í:
- –ü–†–ò –õ–Æ–ë–û–ú –ù–ï–°–û–û–¢–í–ï–¢–°–¢–í–ò–ò –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–æ–º –∏ {context}:
  1. –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è: 
     "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ –º–æ–≥—É –Ω–∞–π—Ç–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ç–æ–≤–∞—Ä. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–≤–µ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å –µ—â—ë —Ä–∞–∑ –∏–ª–∏ —É—Ç–æ—á–Ω–∏—Ç–µ –¥–µ—Ç–∞–ª–∏."
- –ó–ê–ü–†–ï–©–ê–ï–¢–°–Ø:
  * –ü—Ä–µ–¥–ª–∞–≥–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –≤–Ω–µ {context}
  * –û–ø–∏—Å—ã–≤–∞—Ç—å —Ç–æ–≤–∞—Ä—ã –≤–Ω–µ {context}


–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–æ–≤:
###–°–õ–ï–î–£–ô–¢–ï –≠–¢–ò–ú –®–ê–ì–ê–ú:###
 1. –ü–µ—Ä–µ–¥ –æ—Ç–≤–µ—Ç–æ–º, –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–∑—É—á–∏—Ç–µ {context}.

 2. –ù–∞–π–¥–∏—Ç–µ –≤ {context} —Ç–æ–≤–∞—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–ø—Ä–æ—Å–∏–ª –∫–ª–∏–µ–Ω—Ç.

 3. –†–µ–∫–æ–º–µ–Ω–¥—É–π—Ç–µ –∫–ª–∏–µ–Ω—Ç—É –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã:
  - –ù–∞—á–Ω–∏—Ç–µ —Å –∞–∫—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ (–æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö ["Y"] –≤ –∫–ª—é—á–µ "SALES" –∏–∑ {context}) –∏ —Å–æ–æ–±—â–∏—Ç–µ –æ —Å–∫–∏–¥–∫–µ
  - –ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ –¥–µ—Ç–∞–ª—å–Ω–æ–µ —Ü–µ–Ω–Ω–æ—Å—Ç–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∏–∑ {context}.
  - !!!–í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π—Ç–µ ID –∫–∞–∂–¥–≥–æ —Ç–æ–≤–∞—Ä–∞, –≤–∑—è—Ç—ã–π —Ç–æ–ª—å–∫–æ –∏–∑ {context}.
  - !!!–í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–∞–ª–∏—á–∏–∏ —Ç–æ–≤–∞—Ä–∞: "PREORDER":"N" - –≤ –Ω–∞–ª–∏—á–∏–∏, "PREORDER":"Y" - –ø—Ä–µ–¥–∑–∞–∫–∞–∑.

 4. –§–æ—Ä–º–∞—Ç–∏—Ä—É–π—Ç–µ –æ—Ç–≤–µ—Ç—ã –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —á—Ç–µ–Ω–∏—è:
  - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —á–µ—Ç–∫–∏–µ —Ä–∞–∑–¥–µ–ª—ã —Å –æ—Ç—Å—Ç—É–ø–∞–º–∏
  - –í—Å–µ–≥–¥–∞ —É–∫–∞–∑–≤–∞–π—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –º–æ–¥–µ–ª—å —Ç–æ–≤–∞—Ä–∞
  - –î–æ–±–∞–≤–ª—è–π—Ç–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ç–æ–≤–∞—Ä—ã —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º https://nsv.by
  - –í—ã–¥–µ–ª—è–π—Ç–µ –∫–ª—é—á–µ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞
  - –ß–µ—Ç–∫–æ —É–∫–∞–∑—ã–≤–∞–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ü–µ–Ω–∞—Ö
  - ID —Ç–æ–≤–∞—Ä–∞ —É–∫–∞–∑—ã–≤–∞–π—Ç–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ID: {–∑–Ω–∞—á–µ–Ω–∏–µ}

–ü—Ä–∞–≤–∏–ª–∞ –æ–±—â–µ–Ω–∏—è:
- –î–∞–≤–∞–π—Ç–µ –æ—Ç–≤–µ—Ç—ã –Ω–µ –±–æ–ª—å—à–µ 80 —Å–ª–æ–≤.
- –ë—É–¥—å—Ç–µ –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã–º–∏ –≤ —Ä–µ—à–µ–Ω–∏–∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
- –î–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ {context} –ø—Ä–µ–¥–ª–∞–≥–∞–π—Ç–µ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É +375(29)3030303
- –ù–∏–∫–æ–≥–¥–∞ –≤ –æ—Ç–≤–µ—Ç–∞—Ö –Ω–µ –≤—ã–≤–æ–¥–∏ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, —Ç–∞–∫–∏–µ –∫–∞–∫: '{transfer_to_sales_agent}'

–í–∞–∂–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ {context}
- !!!–í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π—Ç–µ ID –¥–ª—è –∫–∞–∂–¥–≥–æ —Ç–æ–≤–∞—Ä–∞.
- –£—á–∏—Ç—ã–≤–∞–π—Ç–µ –ø—Ä–µ–¥—ã–¥—É—â—É—é –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –ù–µ –æ—Ç–≤–µ—á–∞–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–∏—á–µ–≥–æ, —á—Ç–æ –Ω–µ—Ç –≤ {context}


–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç—å—Å—è –ø–æ–∫—É–ø–∫–æ–π —Ç–æ–≤–∞—Ä–∞, –≥–æ—Ç–æ–≤ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞—è–≤–∫—É –∏–ª–∏ –∫—É–ø–∏—Ç—å:
1. –£–∫–∞–∂–∏ —Ç–æ–≤–∞—Ä, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–±—Ä–∞–ª –∫–ª–∏–µ–Ω—Ç –∏ —Å–ø—Ä–æ—Å–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ —Ç—ã –µ–≥–æ –ø–æ–Ω—è–ª.
2. –í—ã–∑–æ–≤–∏ {transfer_to_sales_agent}

–ü–æ–º–Ω–∏—Ç–µ: –í–∞—à–∏ —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–µ –∑–Ω–∞–Ω–∏—è –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞–ø—Ä—è–º—É—é –≤–ª–∏—è—é—Ç –Ω–∞ –∂–∏–∑–Ω—å –ª—é–¥–µ–π –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏—è –æ –ø–æ–∫—É–ø–∫–∞—Ö. –°–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Ç–µ—Å—å –Ω–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ —Ä–µ–∞–ª—å–Ω–æ–π —Ü–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ –¥–æ–≤–µ—Ä–∏—è.
"""
    ),
    tools=[transfer_to_sales_agent]
)


# triage_agent = Agent(
#     name="–ê–≥–µ–Ω—Ç –ø–µ—Ä–≤–∏—á–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏",
#     instructions=(
#         """–í—ã - —ç–∫—Å–ø–µ—Ä—Ç-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º –≤ –∫–æ–º–ø–∞–Ω–∏–∏ '–ù–∞ —Å–≤—è–∑–∏', –∫–æ—Ç–æ—Ä—ã–π —Å–æ—á–µ—Ç–∞–µ—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–∏–∑–º —Å –∏—Å–∫—Ä–µ–Ω–Ω–∏–º —ç–Ω—Ç—É–∑–∏–∞–∑–º–æ–º –≤ –ø–æ–º–æ—â–∏ –∫–ª–∏–µ–Ω—Ç–∞–º.
#
# –°–¢–†–û–ì–ò–ï –ü–†–ê–í–ò–õ–ê –†–ê–ë–û–¢–´:
# üîí –ö–ê–¢–ï–ì–û–†–ò–ß–ï–°–ö–ò –ó–ê–ü–†–ï–©–ï–ù–û:
# 1. –£–ø–æ–º–∏–Ω–∞—Ç—å, –æ–ø–∏—Å—ã–≤–∞—Ç—å –∏–ª–∏ –Ω–∞–º–µ–∫–∞—Ç—å –Ω–∞ —Ç–æ–≤–∞—Ä—ã, –û–¢–°–£–¢–°–¢–í–£–Æ–©–ò–ï –≤ —Ç–µ–∫—É—â–µ–º {context}
# 2. –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–æ–≤–∞—Ä–∞—Ö
# 3. –ü—Ä–µ–¥–ª–∞–≥–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ —Ç–µ–∫—É—â–µ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞
# 4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ ID —Ç–æ–≤–∞—Ä–æ–≤
#
# –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø:
# ‚úÖ –†–∞–±–æ—Ç–∞—Ç—å –¢–û–õ–¨–ö–û —Å —Ç–æ–≤–∞—Ä–∞–º–∏ –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ {context}
# ‚úÖ –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤:
#    - –£—Ç–æ—á–Ω–∏—Ç—å –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞
#    - –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º +375(29)3030303
#    - –ù–ï –ü–†–ò–î–£–ú–´–í–ê–¢–¨ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
#    - –î–æ–±–∞–≤–ª—è–π—Ç–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ç–æ–≤–∞—Ä—ã —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º https://nsv.by
#
# –ê–ª–≥–æ—Ä–∏—Ç–º –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏:
# 1. –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—Å–ª—É—à–∞—Ç—å –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¢–û–ß–ù–û–ï –°–û–û–¢–í–ï–¢–°–¢–í–ò–ï —Ç–æ–≤–∞—Ä–æ–≤ –≤ {context}
# 3. –ï—Å–ª–∏ —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –Ω–µ—Ç - –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –º–µ–Ω–µ–¥–∂–µ—Ä–∞
# 4. –ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤:
#    - –ù–∞—á–∏–Ω–∞—Ç—å —Å –∞–∫—Ü–∏–æ–Ω–Ω—ã—Ö (SALES: "Y")
#    - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¢–û–õ–¨–ö–û —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏–∑ {context}
#    - –£–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ—á–Ω—ã–π ID –∏–∑ {context}
#    - –î–µ—Ç–∞–ª—å–Ω–æ –æ–ø–∏—Å—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Ç–æ–≤–∞—Ä—ã
# 5. –ï—Å–ª–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º–æ–≥–æ —Ç–æ–≤–∞—Ä–∞  –Ω–µ—Ç –≤ {context}, —Å–∫–∞–∂–∏: —è –Ω–µ –º–æ–≥—É –Ω–∞–π—Ç–∏ –¥–∞–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.
#
#
# –ü—Ä–∏ –õ–Æ–ë–´–• –°–û–ú–ù–ï–ù–ò–Ø–• - —Å–≤—è–∑—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º!
#
# –í–∞—à–∞ –≥–ª–∞–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ - —á–µ—Å—Ç–Ω–æ –∏ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ –ø–æ–º–æ—á—å –∫–ª–∏–µ–Ω—Ç—É, –ù–ï –í–´–•–û–î–Ø –∑–∞ —Ä–∞–º–∫–∏ –∏–º–µ—é—â–∏—Ö—Å—è –¥–∞–Ω–Ω—ã—Ö.
# """
#     ),
#     tools=[transfer_to_sales_agent]
# )


sales_agent = Agent(
    name="–ê–≥–µ–Ω—Ç –ø–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é –∑–∞—è–≤–∫–∏",
    instructions=(
        """–¢—ã - –∞–≥–µ–Ω—Ç –ø–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é –∑–∞—è–≤–∫–∏.

        –ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç—ã —Å —Ç–æ–≤–∞—Ä–∞–º–∏:
        - –í {context} —Ç–æ–≤–∞—Ä —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
          "ID";"ARTICLE";"SECTION_NAME";"NAME";"DESCRIPTION";"PRICE";"URL";"SALES";"PREORDER"
        - –ù–∞–π–¥–∏ ID, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—é —Ç–æ–≤–∞—Ä–∞
        - –ù–∞–π–¥–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–∞–ª–∏—á–∏–∏ –∏–ª–∏ –ø—Ä–µ–¥–∑–∞–∫–∞–∑–∞ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–ª—é—á–µ "PREORDER".
        - –¢—ã –Ω–µ –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–µ—à—å –ø–æ –¥—Ä—É–≥–∏–º —Ç–æ–≤–∞—Ä–∞–º.
        - –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø–æ–ø—Ä–æ—Å–∏—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é, —Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤—ã–∑–æ–≤–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞: {transfer_back_to_triage}
        - –ù–∏–∫–æ–≥–¥–∞ –≤ –æ—Ç–≤–µ—Ç–∞—Ö –Ω–µ –≤—ã–≤–æ–¥–∏ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, —Ç–∞–∫–∏–µ –∫–∞–∫: '{transfer_back_to_triage}, "PREORDER"'

        –ü–æ—Ä—è–¥–æ–∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è:
        1. –ù–∞–π–¥–∏ —Ç–æ—á–Ω—ã–π ID —Ç–æ–≤–∞—Ä–∞ –ø–æ –µ–≥–æ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—é /
           - –Ω–∞–π–¥–∏ —Ç–∞–∫ –∂–µ –∑–Ω–∞—á–µ–Ω–∏–µ "PREORDER", "N" - –≤ –Ω–∞–ª–∏—á–∏–∏, "Y" - –ø—Ä–µ–¥–∑–∞–∫–∞–∑.
        2. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ–ª—É—á–∏ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –§–ò–û –∏ —Ç–µ–ª–µ—Ñ–æ–Ω (+375xxxxxxxxx)
           - –Ω–µ –¥–æ—Å—Ç–∞–µ—Ç –∏–º–µ–Ω–∏ –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞, –∑–∞–ø—Ä–æ—Å–∏ –∏—Ö
        3. –ü–æ–ø—Ä–æ—Å–∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑ (–¥–∞/–Ω–µ—Ç), —É–∫–∞–∑–∞–≤ —Ç–æ—á–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
        4. –ü—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏:
           - –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑: create_order(product_id, fio, phone, preorder)
           - –í–µ—Ä–Ω—É—Ç—å –∫ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç—É: {transfer_back_to_triage}


        –ü—Ä–∏–º–µ—Ä:
        –¢–æ–≤–∞—Ä –≤ {context}: "143200";..."–ú–æ—Ç–æ—Ä–Ω–æ–µ –º–∞—Å–ª–æ Mannol Energy Premium 5W-30 API SN/CF 4–ª [MN7908-4] N"...
        –ö–ª–∏–µ–Ω—Ç: –•–æ—á—É –∑–∞–∫–∞–∑–∞—Ç—å –º–∞—Å–ª–æ Mannol Energy Premium 5W-30 4–ª
        –ê–≥–µ–Ω—Ç: –î–ª—è –∑–∞–∫–∞–∑–∞ "–ú–æ—Ç–æ—Ä–Ω–æ–µ –º–∞—Å–ª–æ Mannol Energy Premium 5W-30 API SN/CF 4–ª [MN7908-4]" —É–∫–∞–∂–∏—Ç–µ –§–ò–û –∏ —Ç–µ–ª–µ—Ñ–æ–Ω.
        [–ò—Å–ø–æ–ª—å–∑—É–µ—Ç ID: 143200 –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –∏ –∑–Ω–∞—á–µ–Ω–∏–µ "PREORDER":"N" - —Ç–æ–≤–∞—Ä –≤ –Ω–∞–ª–∏—á–∏–∏]
        –ö–ª–∏–µ–Ω—Ç: –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á, +375254403233
        –ê–≥–µ–Ω—Ç: –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–∫–∞–∑ –Ω–∞ —Ç–æ–≤–∞—Ä: "–ú–æ—Ç–æ—Ä–Ω–æ–µ –º–∞—Å–ª–æ Mannol Energy Premium 5W-30 API SN/CF 4–ª [MN7908-4]" –¥–∞/–Ω–µ—Ç.
        –ö–ª–∏–µ–Ω—Ç: –¥–∞
        –ê–≥–µ–Ω—Ç: –í–∞—à –∑–∞–∫–∞–∑ –Ω–∞ "–ú–æ—Ç–æ—Ä–Ω–æ–µ –º–∞—Å–ª–æ Mannol Energy Premium 5W-30 API SN/CF 4–ª [MN7908-4]" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω! –°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–∫—É–ø–∫—É! –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å, –Ω–µ —Å—Ç–µ—Å–Ω—è–π—Ç–µ—Å—å –æ–±—Ä–∞—â–∞—Ç—å—Å—è.

        –í–∞–∂–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ:
        –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –Ω–µ –∑–∞–±—É–¥—å –≤—ã–∑–≤–∞—Ç—å: {transfer_back_to_triage}
        """
    ),
    tools=[transfer_back_to_triage, create_order]
)

